# lperf - 移动应用性能测试工具

> 专业的Android和iOS应用性能测试工具，支持多维度性能指标采集、应用生命周期自动测试和增强稳定性机制

## ✨ 核心特性

- **多维度指标**：CPU、内存、电池、网络流量、FPS帧率、启动时间
- **多应用并行测试**：支持同时对多个应用进行并行性能测试
- **应用生命周期自动测试**：根据应用启动和关闭来自动启动和关闭性能测试
- **增强稳定性**：设备连接检测、命令执行重试、数据收集降级等机制
- **可视化报告**：生成静态图表和交互式HTML报告
- **版本兼容性**：支持Android 8-16+和iOS 10-18+

## 🚀 快速开始

### 安装依赖

```bash
# 安装Python依赖
pip install -r requirements.txt

# 安装平台工具
# Android: 安装ADB工具
# iOS: 安装libimobiledevice工具
```

### 基本用法

```bash
# 测试单个应用性能
python3 lperf.py -p com.example.app -t 60

# 测试应用启动时间
python3 lperf.py -p com.example.app --startup

# 应用生命周期自动测试
python3 lperf.py -p com.example.app --auto-lifecycle --wait-time 30

# 多应用并行测试
python3 lperf.py -p com.example.app1 com.example.app2 -t 60
```

## 🔧 命令行参数

```
-p, --package       应用包名（Android）或Bundle ID（iOS）
-d, --device        设备ID列表（可选）
-i, --interval      数据采集间隔(秒)，默认1秒
-t, --time          测试时长(秒)
-o, --output        结果输出目录，默认./reports
--startup           仅测试启动时间
--auto-lifecycle    应用生命周期自动测试
--wait-time         等待时间（秒），默认30秒
--platform          平台类型: android, ios
--no-charts         不生成静态图表
--no-interactive    不生成交互式HTML报告
```

## 📊 功能详解

### 性能指标采集

- **CPU使用率**：实时监控应用CPU占用情况
- **内存使用**：监控应用内存占用和PSS值
- **电池状态**：监控设备电池电量和充电状态
- **网络流量**：监控应用前台和后台网络使用量
- **FPS帧率**：评估应用流畅度和绘制性能
- **启动时间**：精确测量应用启动到完全加载的时间

### 应用生命周期自动测试

支持根据应用启动和关闭来自动启动和关闭性能测试：

1. **自动关闭应用** - 确保应用处于关闭状态
2. **启动应用** - 自动启动目标应用
3. **等待启动完成** - 智能等待应用完全加载
4. **开始性能监控** - 自动开始收集性能数据
5. **等待指定时间** - 监控运行指定时长（默认30秒）
6. **停止监控** - 自动停止数据收集
7. **关闭应用** - 自动关闭应用
8. **保存结果** - 保存本次测试数据

### 增强稳定性机制

- **设备连接稳定性**：自动检测设备响应性，优先使用响应正常的设备
- **命令执行重试**：ADB和iOS命令执行失败时自动重试，支持指数退避策略
- **数据收集降级**：性能数据获取失败时自动使用默认值，确保测试继续进行
- **系统健康检查**：定期检查设备连接、工具可用性、系统资源和网络状态
- **自动恢复机制**：检测到问题时自动尝试修复，包括重启ADB服务、重新检测设备等

## 🧪 测试脚本

### 基础稳定性测试

```bash
# 运行基础稳定性测试
python3 stability_test.py
```

### 增强稳定性测试

```bash
# 运行增强稳定性测试（包含健康检查和自动恢复）
python3 enhanced_stability_test.py
```

### 高级功能演示

```bash
# 运行高级功能演示
python3 advanced_features_demo.py
```

### 应用生命周期演示

```bash
# 运行应用生命周期演示
python3 app_lifecycle_demo.py
```

## 📈 测试结果

测试完成后会生成：

- **JSON数据文件**：原始性能数据
- **摘要报告**：关键指标汇总
- **静态图表**：性能趋势可视化
- **交互式HTML报告**：详细的性能分析报告

## 🔍 版本兼容性

### Android版本支持

| 版本范围 | 支持特性 | 备注 |
|---------|---------|------|
| Android 8-11 | 基础性能指标 | 传统API方法 |
| Android 12-13 | 增强性能指标 | 部分新特性支持 |
| Android 14+ | 完整功能支持 | 最新API方法 |

### iOS版本支持

| 版本范围 | 支持特性 | 备注 |
|---------|---------|------|
| iOS 10-14 | 基础性能指标 | 传统方法支持 |
| iOS 15-16 | 增强性能指标 | 部分新特性支持 |
| iOS 17+ | 完整功能支持 | 最新系统特性 |

## 🛠️ 环境要求

- **Python**: 3.7+
- **Android设备**: Android 8.0+，通过ADB连接
- **iOS设备**: iOS 10.0+，通过libimobiledevice连接
- **系统工具**: ADB、libimobiledevice工具链

## 📚 技术架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   应用层        │    │   平台抽象层     │    │   设备连接层     │
│                 │    │                 │    │                 │
│ • 命令行接口    │───▶│ • Android适配   │───▶│ • ADB连接      │
│ • 配置管理      │    │ • iOS适配       │    │ • libimobiledevice│
│ • 报告生成      │    │ • 版本检测      │    │ • 设备管理      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   数据采集层     │    │   稳定性增强层   │    │   结果处理层     │
│                 │    │                 │    │                 │
│ • CPU监控       │    │ • 健康检查      │    │ • 数据存储      │
│ • 内存监控      │    │ • 自动恢复      │    │ • 重试机制      │
│ • 网络监控      │    │ • 降级处理      │    │ • 报告生成      │
│ • FPS监控       │    │ • 图表绘制      │    │ • 结果分析      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进lperf工具。

## 📄 许可证

本项目采用MIT许可证，详见[LICENSE](LICENSE)文件。